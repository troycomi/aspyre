from unittest import TestCase
from aspyre.apple.apple import Apple
import pytest

import os.path
DATA_DIR = os.path.join(os.path.dirname(__file__), 'saved_test_data', 'mrc_files')


class ApplePickerTestCase(TestCase):
    def setUp(self):
        pass

    def tearDown(self):
        pass

    @pytest.mark.acceptance
    def testPickCenters(self):
        # 504 particles with the following centers
        centers = {
            (2767, 3405), ( 725, 3489), (1769, 2633), (2147, 2731), (2349, 3099), (1237, 1573), (1191, 3391),
            (3097, 2901), ( 965,  893), ( 335, 1723), (3305, 2605), (3379, 2537), ( 603, 1435), (3085, 1457),
            ( 241,  323), (2243, 2329), (1563, 1877), (1217, 3149), (1435, 2195), ( 393, 2591), ( 151,  507),
            (3125,  849), (1559, 3195), (2755, 1453), (2755, 1217), (2965,  273), ( 371, 1121), (3131,  355),
            ( 343, 3381), (1965, 2397), (1435, 1759), (3675, 1113), (3561, 1577), (3693, 1639), (1169, 3793),
            (1241, 1975), (2651,  983), ( 721, 1181), (3845, 1959), (1807, 3423), (3437, 1073), ( 321, 2469),
            (3229,  537), (1085, 2757), (2453,  307), (2165,  249), ( 295, 1455), (2743, 2205), ( 357, 3623),
            (3919, 2633), (2473,  909), (1513, 3789), ( 731, 2491), (3527, 2843), ( 215, 2717), (1965, 1329),
            (1667, 2003), (3127, 2277), (2369, 3491), (1477,  875), (3399, 2145), (2319, 2211), (1321,  361),
            ( 781, 3781), ( 811, 2337), (1717,  165), (1445,  981), ( 671, 3681), (2039, 3705), (3173, 1713),
            (1597,  159), (2485,  861), (2527, 1489), (2489, 1869), (3437, 3575), ( 951, 3061), ( 371, 3385),
            (2971, 3115), (2847, 3885), (3115,  687), (2001, 2605), (2481,  625), (3065,  809), ( 995, 3195),
            (1369, 2845), ( 437, 3097), (2129, 3589), ( 673, 3701), ( 157, 1299), (1993, 1333), ( 501, 3457),
            ( 443, 2009), (3441, 1535), (3439, 2685), (3507, 2905), (1553, 1945), (2989,  265), (3169, 1407),
            (1525,  737), (2209,  723), ( 553, 2917), ( 827, 3401), (2701, 3551), (1995,  551), (3903, 1643),
            (3053,  239), (1943, 2205), (3275, 3681), (1571, 3571), (2699,  533), (1593, 1525), (2637,  173),
            ( 407,  767), (2073,  959), (3559, 2439), (1007, 2923), (1073, 3317), (2417, 2563), (3613, 2053),
            ( 599,  409), (3075, 1807), (2665, 3855), ( 457,  259), (3675, 1037), ( 803, 2037), ( 347, 1253),
            (3733, 2251), (2403, 3623), ( 531, 1291), (1269, 1337), ( 717, 3201), (1225, 2517), ( 859, 1241),
            ( 817, 2625), (1239, 3299), (1987, 1693), (2505, 2623), (2813, 3727), (2835, 2219), (3485, 3909),
            (1647,  273), ( 897, 2645), (1283, 3919), (1371, 3599), (3009,  271), (1153, 1831), (1033, 2975),
            (1491, 2743), (1361, 1521), (2427, 2173), (3227, 3293), (3463,  821), (3479, 1469), ( 923, 3505),
            (2791,  693), ( 487, 1461), (3187,  627), ( 967, 2305), (1479, 1369), ( 505, 1653), (2937,  867),
            (1375,  819), (3391,  915), ( 933, 1401), ( 783, 1853), (2733,  405), (1007, 1659), (1877, 2617),
            (2475, 3051), (2841, 1069), (3581, 2735), (3691, 3481), (2485, 2479), (3939, 2147), (2647, 1425),
            (1953, 1559), (1509,  849), ( 699, 2639), (2973,  963), ( 263, 1367), ( 243,  181), (1461, 1139),
            (3425, 2485), (1115, 1665), (3319, 2833), (3573,  861), (3267, 1237), (1245, 2381), (2241, 2251),
            (3181, 2977), (3763, 3583), ( 505, 3613), (2281, 1539), (3823, 2677), (1233, 2135), ( 699,  735),
            (3729, 1467), (1123, 3695), (2359, 1861), (2069, 1851), (2651, 2063), ( 543,  613), ( 697, 3603),
            ( 583, 3551), ( 991, 1535), ( 355, 1883), (3377,  403), (2697,  667), (1271,  927), (3579, 1729),
            ( 531, 1991), (1961, 2677), (1859, 3871), (3001, 2395), (1703, 3403), (3847, 2541), (1887, 3387),
            (1363, 2551), (3825, 2811), (1237,  939), (1423,  613), ( 381, 3471), ( 747,  581), (3505, 2175),
            (1941, 3299), (1837,  285), (2999,  271), (1163,  837), ( 239,  733), (3199,  959), ( 547, 2425),
            ( 325, 3679), (1641,  609), (1455, 3491), (1329, 1685), ( 217, 1263), (3473, 2509), (2655, 3477),
            ( 889,  669), (2127, 1239), (2619, 1913), (1913, 1305), (3249, 1887), (3941, 3579), ( 391,  363),
            ( 255, 1923), (3285, 1773), (3251, 2699), ( 239, 2193), (2337,  759), (2293, 3163), ( 847, 2883),
            ( 705, 3087), ( 239, 2371), (3367, 1753), (1839,  939), (3475, 1987), (3809, 1191), (1941, 3053),
            (1387, 1965), (1703,  885), ( 595, 1641), (3347, 3475), (1737, 3777), (3515, 3635), (1361, 1113),
            (2083,  669), (1955, 1821), (3259, 2629), (1639, 2455), (2935, 2585), (1249,  451), ( 873,  373),
            (1905,  861), (2519, 1981), (3809, 1549), ( 479, 1135), ( 765, 2581), (1513, 1719), (2711, 1737),
            (2581, 3575), (3471,  701), (3635, 3257), (3783, 3089), (2185, 1337), (2505, 2477), (3169, 1069),
            (3533, 2297), ( 515, 2891), ( 151,  617), (1815, 2793), (1525, 2861), (1573, 2659), ( 437, 2427),
            ( 547, 1037), (1531, 2387), ( 221, 3243), (3069, 1549), (2215, 3787), (3029, 1607), (3569, 1457),
            (2085, 3689), (3123, 1265), (1015, 2365), (3877, 3063), (3211,  403), ( 851, 3081), (2063,  151),
            (1357, 2351), (2385, 1429), ( 159, 1005), ( 349,  941), ( 533, 2605), (2141, 2491), (1529,  957),
            (3653, 2847), (1733,  715), ( 973, 1851), (1583, 2977), (3321,  547), (2177,  821), ( 155,  737),
            (1209,  779), (2773, 2767), (3589, 3653), (1371, 3055), (1347, 3307), (1851, 3047), (2961, 1465),
            (2069, 1389), (2243, 2469), (3369, 3213), (3587,  993), (2157, 3247), (1953,  367), (3289, 1671),
            (3039, 1087), (1905, 1029), (3219,  709), (1027, 3625), ( 861, 1837), ( 387, 2929), (2173, 3035),
            (3287, 2099), (1159,  981), ( 667, 2389), (1455,  227), (2431,  687), (3873, 1455), (2623, 1069),
            ( 829, 2999), ( 529, 3151), ( 757, 1775), (1765, 2507), (2781, 3059), ( 859, 1945), (2711, 2365),
            (1023,  209), (1469, 1547), (2055, 3857), (2927, 2257), ( 919, 2137), (1249, 3039), (1729, 3193),
            (3161, 3761), ( 463,  693), (1943, 2217), (2969,  641), ( 167, 1681), (3105, 1343), (1047, 1235),
            (2997, 3771), ( 441,  517), ( 885, 2017), ( 913, 2827), (1449, 2205), (1027, 1075), (2371, 2675),
            (1653, 1547), ( 367, 2003), (3107, 3335), (1145, 1513), ( 525, 3769), (3093, 2327), ( 281, 3079),
            (2469, 1441), (1287,  221), (3709, 2991), (3557, 1233), (1821,  863), (1741, 1391), (1251, 2827),
            (2731, 3337), (2213, 1747), (2659, 3723), (3657, 2237), (1719,  367), ( 495, 1991), (1917, 2829),
            (3363, 2385), (2133, 1657), (2037, 3279), ( 981, 1749), (1809, 2281), (1583,  931), (3087,  501),
            (1199, 1685), (3931, 2957), (1121, 2503), (2675, 2753), (2645, 1331), ( 859, 3253), ( 235, 3887),
            (3009, 3499), ( 391, 1577), (3901, 3227), ( 937,  333), (1547, 1649), (3837, 3571), (1413, 2449),
            ( 747, 3295), ( 607, 1871), (1831,  915), (3449,  587), (1693, 1255), (3065, 3761), (3389,  723),
            (2277,  935), ( 785,  511), (2413,  507), (1507,  533), ( 155, 3889), (1725, 1699), (3677, 1337),
            (2269, 1327), ( 987,  707), ( 591, 1115), (2025, 1167), (2661, 2585), (1497, 3311), (2541,  201),
            ( 175, 3889), (1195,  651), ( 555,  227), ( 925,  493), ( 255, 2603), ( 713,  187), (1479, 3093),
            ( 603, 2939), (3079, 3439), (2593,  621), (3753, 3401), (1757, 1099), (2291, 3333), (3139, 2259),
            ( 501, 3307), (2973,  271), (1617, 3569), (2827, 1965), (3129,  285), (2047, 3593), (3081, 3837),
            (3783, 2341), (3593, 3537), (3215, 3507), (2239, 3905), (3239, 1141), (2557, 3047), (2355, 2867),
            (3337, 3317), (1689,  819), (2671,  831), (1087, 3503), (3493,  627), (1101, 2001), (3893, 3729),
            (1795, 1283), (1937, 3529), (2115, 2285), (2897, 1081), (2983,  267), (2671, 1619), (1733, 2743),
            (2373, 3337), (1913, 1937), (1257, 2275), (3141, 2233), (1095, 2867), (3349, 3391), (3919, 2375),
            (2639,  489), (2023, 2833), (3817, 3711), ( 951, 2893), (1805, 2133), ( 787, 1589), (3367, 2281),
            (3693, 1231), (2957, 1265), (2503, 3493), (2045,  781), (2585, 1871), (2547, 1271), (3441, 1841)
        }

        apple_picker = Apple()

        centers_found = apple_picker.process_micrograph(os.path.join(DATA_DIR, 'falcon_2012_06_12-14_33_35_0.mrc'))
        for center_found in centers_found:
            _x, _y = tuple(center_found)
            if (_x, _y) not in centers:
                self.fail('({}, {}) not an expected center.'.format(_x, _y))
            else:
                centers.remove((_x, _y))

        if centers:
            self.fail('Not all expected centers were found!')


